name: convert images
on: workflow_dispatch

jobs:
  convertimages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: git congig buffer
        run: git config --global http.postBuffer 157286400
      - name: poppler
        run: sudo apt-get install -y poppler-utils
      - name: test
        run: ls
      - name: pip install
        run: pip3 install iiif pdf2image Pillow iiif-prezi git+https://github.com/giacomomarchioro/pyIIIFpres
      - name: runscript
        run: python3 -c "exec(\"from iiif.static import IIIFStatic\nfrom IIIFpres import iiifpapi3\nfrom PIL import Image\nimport os\nfrom pdf2image import convert_from_path\nfrom iiif_prezi.factory import ManifestFactory\n\nfiles = [('images/BitchPlanetVol10.jpg', 'Bitch Planet Vol 1-0'), ('images/BitchPlanetVol11.jpg', 'Bitch Planet Vol 1-1'), ('images/BitchPlanetVol12.jpg', 'Bitch Planet Vol 1-2'), ('images/BitchPlanetVol13.jpg', 'Bitch Planet Vol 1-3'), ('images/BitchPlanetVol14.jpg', 'Bitch Planet Vol 1-4'), ('images/BitchPlanetVol15.jpg', 'Bitch Planet Vol 1-5'), ('images/BitchPlanetVol16.jpg', 'Bitch Planet Vol 1-6'), ('images/BitchPlanetVol17.jpg', 'Bitch Planet Vol 1-7'), ('images/BitchPlanetVol18.jpg', 'Bitch Planet Vol 1-8'), ('images/BitchPlanetVol19.jpg', 'Bitch Planet Vol 1-9'), ('images/BitchPlanetVol110.jpg', 'Bitch Planet Vol 1-10'), ('images/BitchPlanetVol111.jpg', 'Bitch Planet Vol 1-11'), ('images/BitchPlanetVol112.jpg', 'Bitch Planet Vol 1-12'), ('images/BitchPlanetVol113.jpg', 'Bitch Planet Vol 1-13'), ('images/BitchPlanetVol114.jpg', 'Bitch Planet Vol 1-14'), ('images/BitchPlanetVol115.jpg', 'Bitch Planet Vol 1-15'), ('images/BitchPlanetVol116.jpg', 'Bitch Planet Vol 1-16'), ('images/BitchPlanetVol117.jpg', 'Bitch Planet Vol 1-17'), ('images/BitchPlanetVol118.jpg', 'Bitch Planet Vol 1-18'), ('images/BitchPlanetVol119.jpg', 'Bitch Planet Vol 1-19'), ('images/BitchPlanetVol120.jpg', 'Bitch Planet Vol 1-20'), ('images/BitchPlanetVol121.jpg', 'Bitch Planet Vol 1-21'), ('images/BitchPlanetVol122.jpg', 'Bitch Planet Vol 1-22'), ('images/BitchPlanetVol123.jpg', 'Bitch Planet Vol 1-23'), ('images/BitchPlanetVol124.jpg', 'Bitch Planet Vol 1-24'), ('images/BitchPlanetVol125.jpg', 'Bitch Planet Vol 1-25'), ('images/BitchPlanetVol126.jpg', 'Bitch Planet Vol 1-26'), ('images/BitchPlanetVol127.jpg', 'Bitch Planet Vol 1-27'), ('images/BitchPlanetVol128.jpg', 'Bitch Planet Vol 1-28'), ('images/BitchPlanetVol129.jpg', 'Bitch Planet Vol 1-29'), ('images/BitchPlanetVol130.jpg', 'Bitch Planet Vol 1-30'), ('images/BitchPlanetVol131.jpg', 'Bitch Planet Vol 1-31'), ('images/BitchPlanetVol132.jpg', 'Bitch Planet Vol 1-32'), ('images/BitchPlanetVol133.jpg', 'Bitch Planet Vol 1-33'), ('images/BitchPlanetVol134.jpg', 'Bitch Planet Vol 1-34'), ('images/BitchPlanetVol135.jpg', 'Bitch Planet Vol 1-35'), ('images/BitchPlanetVol136.jpg', 'Bitch Planet Vol 1-36'), ('images/BitchPlanetVol137.jpg', 'Bitch Planet Vol 1-37'), ('images/BitchPlanetVol138.jpg', 'Bitch Planet Vol 1-38'), ('images/BitchPlanetVol139.jpg', 'Bitch Planet Vol 1-39'), ('images/BitchPlanetVol140.jpg', 'Bitch Planet Vol 1-40'), ('images/BitchPlanetVol141.jpg', 'Bitch Planet Vol 1-41'), ('images/BitchPlanetVol142.jpg', 'Bitch Planet Vol 1-42'), ('images/BitchPlanetVol143.jpg', 'Bitch Planet Vol 1-43'), ('images/BitchPlanetVol144.jpg', 'Bitch Planet Vol 1-44'), ('images/BitchPlanetVol145.jpg', 'Bitch Planet Vol 1-45'), ('images/BitchPlanetVol146.jpg', 'Bitch Planet Vol 1-46'), ('images/BitchPlanetVol147.jpg', 'Bitch Planet Vol 1-47'), ('images/BitchPlanetVol148.jpg', 'Bitch Planet Vol 1-48'), ('images/BitchPlanetVol149.jpg', 'Bitch Planet Vol 1-49'), ('images/BitchPlanetVol150.jpg', 'Bitch Planet Vol 1-50'), ('images/BitchPlanetVol151.jpg', 'Bitch Planet Vol 1-51'), ('images/BitchPlanetVol152.jpg', 'Bitch Planet Vol 1-52'), ('images/BitchPlanetVol153.jpg', 'Bitch Planet Vol 1-53'), ('images/BitchPlanetVol154.jpg', 'Bitch Planet Vol 1-54'), ('images/BitchPlanetVol155.jpg', 'Bitch Planet Vol 1-55'), ('images/BitchPlanetVol156.jpg', 'Bitch Planet Vol 1-56'), ('images/BitchPlanetVol157.jpg', 'Bitch Planet Vol 1-57'), ('images/BitchPlanetVol158.jpg', 'Bitch Planet Vol 1-58'), ('images/BitchPlanetVol159.jpg', 'Bitch Planet Vol 1-59'), ('images/BitchPlanetVol160.jpg', 'Bitch Planet Vol 1-60'), ('images/BitchPlanetVol161.jpg', 'Bitch Planet Vol 1-61'), ('images/BitchPlanetVol162.jpg', 'Bitch Planet Vol 1-62'), ('images/BitchPlanetVol163.jpg', 'Bitch Planet Vol 1-63'), ('images/BitchPlanetVol164.jpg', 'Bitch Planet Vol 1-64'), ('images/BitchPlanetVol165.jpg', 'Bitch Planet Vol 1-65'), ('images/BitchPlanetVol166.jpg', 'Bitch Planet Vol 1-66'), ('images/BitchPlanetVol167.jpg', 'Bitch Planet Vol 1-67'), ('images/BitchPlanetVol168.jpg', 'Bitch Planet Vol 1-68'), ('images/BitchPlanetVol169.jpg', 'Bitch Planet Vol 1-69'), ('images/BitchPlanetVol170.jpg', 'Bitch Planet Vol 1-70'), ('images/BitchPlanetVol171.jpg', 'Bitch Planet Vol 1-71'), ('images/BitchPlanetVol172.jpg', 'Bitch Planet Vol 1-72'), ('images/BitchPlanetVol173.jpg', 'Bitch Planet Vol 1-73'), ('images/BitchPlanetVol174.jpg', 'Bitch Planet Vol 1-74'), ('images/BitchPlanetVol175.jpg', 'Bitch Planet Vol 1-75'), ('images/BitchPlanetVol176.jpg', 'Bitch Planet Vol 1-76'), ('images/BitchPlanetVol177.jpg', 'Bitch Planet Vol 1-77'), ('images/BitchPlanetVol178.jpg', 'Bitch Planet Vol 1-78'), ('images/BitchPlanetVol179.jpg', 'Bitch Planet Vol 1-79'), ('images/BitchPlanetVol180.jpg', 'Bitch Planet Vol 1-80'), ('images/BitchPlanetVol181.jpg', 'Bitch Planet Vol 1-81'), ('images/BitchPlanetVol182.jpg', 'Bitch Planet Vol 1-82'), ('images/BitchPlanetVol183.jpg', 'Bitch Planet Vol 1-83'), ('images/BitchPlanetVol184.jpg', 'Bitch Planet Vol 1-84'), ('images/BitchPlanetVol185.jpg', 'Bitch Planet Vol 1-85'), ('images/BitchPlanetVol186.jpg', 'Bitch Planet Vol 1-86'), ('images/BitchPlanetVol187.jpg', 'Bitch Planet Vol 1-87'), ('images/BitchPlanetVol188.jpg', 'Bitch Planet Vol 1-88'), ('images/BitchPlanetVol189.jpg', 'Bitch Planet Vol 1-89'), ('images/BitchPlanetVol190.jpg', 'Bitch Planet Vol 1-90'), ('images/BitchPlanetVol191.jpg', 'Bitch Planet Vol 1-91'), ('images/BitchPlanetVol192.jpg', 'Bitch Planet Vol 1-92'), ('images/BitchPlanetVol193.jpg', 'Bitch Planet Vol 1-93'), ('images/BitchPlanetVol194.jpg', 'Bitch Planet Vol 1-94'), ('images/BitchPlanetVol195.jpg', 'Bitch Planet Vol 1-95'), ('images/BitchPlanetVol196.jpg', 'Bitch Planet Vol 1-96'), ('images/BitchPlanetVol197.jpg', 'Bitch Planet Vol 1-97'), ('images/BitchPlanetVol198.jpg', 'Bitch Planet Vol 1-98'), ('images/BitchPlanetVol199.jpg', 'Bitch Planet Vol 1-99'), ('images/BitchPlanetVol1100.jpg', 'Bitch Planet Vol 1-100'), ('images/BitchPlanetVol1101.jpg', 'Bitch Planet Vol 1-101'), ('images/BitchPlanetVol1102.jpg', 'Bitch Planet Vol 1-102'), ('images/BitchPlanetVol1103.jpg', 'Bitch Planet Vol 1-103'), ('images/BitchPlanetVol1104.jpg', 'Bitch Planet Vol 1-104'), ('images/BitchPlanetVol1105.jpg', 'Bitch Planet Vol 1-105'), ('images/BitchPlanetVol1106.jpg', 'Bitch Planet Vol 1-106'), ('images/BitchPlanetVol1107.jpg', 'Bitch Planet Vol 1-107'), ('images/BitchPlanetVol1108.jpg', 'Bitch Planet Vol 1-108'), ('images/BitchPlanetVol1109.jpg', 'Bitch Planet Vol 1-109'), ('images/BitchPlanetVol1110.jpg', 'Bitch Planet Vol 1-110'), ('images/BitchPlanetVol1111.jpg', 'Bitch Planet Vol 1-111'), ('images/BitchPlanetVol1112.jpg', 'Bitch Planet Vol 1-112'), ('images/BitchPlanetVol1113.jpg', 'Bitch Planet Vol 1-113'), ('images/BitchPlanetVol1114.jpg', 'Bitch Planet Vol 1-114'), ('images/BitchPlanetVol1115.jpg', 'Bitch Planet Vol 1-115'), ('images/BitchPlanetVol1116.jpg', 'Bitch Planet Vol 1-116'), ('images/BitchPlanetVol1117.jpg', 'Bitch Planet Vol 1-117'), ('images/BitchPlanetVol1118.jpg', 'Bitch Planet Vol 1-118'), ('images/BitchPlanetVol1119.jpg', 'Bitch Planet Vol 1-119'), ('images/BitchPlanetVol1120.jpg', 'Bitch Planet Vol 1-120'), ('images/BitchPlanetVol1121.jpg', 'Bitch Planet Vol 1-121'), ('images/BitchPlanetVol1122.jpg', 'Bitch Planet Vol 1-122'), ('images/BitchPlanetVol1123.jpg', 'Bitch Planet Vol 1-123'), ('images/BitchPlanetVol1124.jpg', 'Bitch Planet Vol 1-124'), ('images/BitchPlanetVol1125.jpg', 'Bitch Planet Vol 1-125'), ('images/BitchPlanetVol1126.jpg', 'Bitch Planet Vol 1-126'), ('images/BitchPlanetVol1127.jpg', 'Bitch Planet Vol 1-127'), ('images/BitchPlanetVol1128.jpg', 'Bitch Planet Vol 1-128'), ('images/BitchPlanetVol1129.jpg', 'Bitch Planet Vol 1-129'), ('images/BitchPlanetVol1130.jpg', 'Bitch Planet Vol 1-130'), ('images/BitchPlanetVol1131.jpg', 'Bitch Planet Vol 1-131'), ('images/BitchPlanetVol1132.jpg', 'Bitch Planet Vol 1-132'), ('images/BitchPlanetVol1133.jpg', 'Bitch Planet Vol 1-133'), ('images/BitchPlanetVol1134.jpg', 'Bitch Planet Vol 1-134'), ('images/BitchPlanetVol1135.jpg', 'Bitch Planet Vol 1-135'), ('images/BitchPlanetVol1136.jpg', 'Bitch Planet Vol 1-136'), ('images/BitchPlanetVol1137.jpg', 'Bitch Planet Vol 1-137'), ('images/BitchPlanetVol1138.jpg', 'Bitch Planet Vol 1-138'), ('images/BitchPlanetVol1139.jpg', 'Bitch Planet Vol 1-139')]\nmanifestlabel = '''Bitch Planet'''\ndst = os.path.join('img/derivatives/iiif/', 'bitchplanet') + '/'\nbaseurl = os.path.join('https://annonatatencsu.github.io/FeministFutures/', dst)\ndata = []\nfor idx, filedict in enumerate(files):\n    file = filedict[0]\n    filepath,ext = file.rsplit('.', 1)\n    if ext == 'pdf':\n        images = convert_from_path(file)\n        for i in range(len(images)):\n            imagefilename = filepath + '-' + str(i) +'.jpg'\n            images[i].save(imagefilename, 'JPEG')\n            files.append([imagefilename, filedict[1]])\n        del files[idx]\n        os.remove(file)\n    elif ext != 'jpg' and ext != 'jpeg':\n        os.system('convert {} {}.jpg'.format(file, filepath))\n        files.append(('%s.jpg'%filepath, filedict[1]))\n        del files[idx]\n        os.remove(file)\nfor filedict in files:\n    file = filedict[0]\n    filepath,ext = file.rsplit('.', 1)\n    filename = os.path.basename(filepath)\n    if ext != 'jpg' and ext != 'jpeg':\n        os.system('convert {} {}.jpg'.format(file, filepath))\n    sg = IIIFStatic(prefix=baseurl, dst=dst)\n    sggenerate = sg.generate(file)\n    img = Image.open(file)\n    data.append((filename, img.width, img.height, os.path.join(baseurl, filename),'/full/full/0/default.jpg', filedict[1]))\n    iiiffulldir = os.path.join(dst, filename, 'full/full')\n    if not os.path.isdir(iiiffulldir):\n        os.mkdir(iiiffulldir)\n        iiiffulldir = os.path.join(iiiffulldir, '0')\n        os.mkdir(iiiffulldir)\n    else:\n        iiiffulldir = os.path.join(iiiffulldir, '0')\n    os.system('mv {} {}'.format(file, os.path.join(iiiffulldir, 'default.jpg')))\niiifpapi3.BASE_URL = baseurl\nmanifest = iiifpapi3.Manifest()\nmanifest.set_id(extendbase_url='manifest.json')\nmanifest.add_label('en',manifestlabel)\nmanifest.add_behavior('paged')\ndescription = manifest.add_summary('en', '''''')\nmanifest.set_viewingDirection('left-to-right')\nrights = ''''''\nif rights:\n    try:\n        manifest.set_rights(rights)\n    except:\n        manifest.add_metadata('rights', rights, 'en', 'en')\n\ndata = tuple(data)\nfor idx,d in enumerate(data):\n    idx+=1\n    canvas = manifest.add_canvas_to_items()\n    canvas.set_id(extendbase_url='canvas/bitchplanet-%s'%idx)\n    canvas.set_height(d[2])\n    canvas.set_width(d[1])\n    canvas.add_label('en', d[5])\n    filteredallfiles = [f for f in os.listdir(os.path.join(dst, d[0], 'full')) if f != 'full' and int(f.split(',')[0]) > 70]\n    filteredallfiles.sort()\n    size = filteredallfiles[0] if len(filteredallfiles) > 0 else '80,'\n    thumbnail = canvas.add_thumbnail()\n    thumbnail.set_id('{}/full/{}/0/default.jpg'.format(d[3], size))\n    annopage = canvas.add_annotationpage_to_items()\n    annopage.set_id(extendbase_url='page/p%s/1' %idx)\n    annotation = annopage.add_annotation_to_items(target=canvas.id)\n    annotation.set_id(extendbase_url='annotation/p%s-image'%str(idx).zfill(4))\n    annotation.set_motivation('painting')\n    annotation.body.set_id(''.join(d[3:5]))\n    annotation.body.set_type('Image')\n    annotation.body.set_format('image/jpeg')\n    annotation.body.set_width(d[1])\n    annotation.body.set_height(d[2])\n    s = annotation.body.add_service()\n    s.set_id(d[3])\n    s.set_type('ImageService2')\n    s.set_profile('level1')\n\nmanifest.json_save(os.path.join(dst, 'manifest.json'))\n\")"
      - name: add page jekyll to manifest
        run: echo -e "---\n---\n$(cat img/derivatives/iiif/bitchplanet/manifest.json)" > img/derivatives/iiif/bitchplanet/manifest.json
      - name: commit files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git config pull.rebase false
          git config --global http.postBuffer 157286400
          git add -A
          git commit -m "Create bitchplanet manifest and IIIF derivatives" -a
      - name: pull
        run: git pull origin main
      - name: push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main 
